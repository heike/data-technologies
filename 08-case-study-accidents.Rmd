---
knit: bookdown::preview_chapter
---

# Accidents

The US Department of transportation is keeping a detailed track of every accident that results in a fatality. This data are part of FARS, the [Fatality Analysis Reporting System](http://www.nhtsa.gov/FARS). Data is available in annual releases going back to 1975. 
Accident forms change over time, and the corresponding databases with them - e.g. cell phones as a potential contributor to an accident were not on the list back in the 80s. This often makes an analysis of trends over time a bit tricky. 

Here, we  first focus on a single year's worth of data. The data is released in different formats. Besides SAS, DBF seems to be a staple at the DOT. DBF stands for 'data base format', and in R we can read files in this format using the function ```read.dbf```, which is part of the package ```foreign``` [@R-foreign]. Files in SAS format can be read with package ```sas7bdat``` [@R-sas7bdat]. Generally, files in SAS format are a bit smaller than the ones in DBF, but the ```read.dbf``` function is much faster than the ```read.sas7bdat``` function. However, the SAS files come with a file called ```Format.sas```, which contains a translation of numerical codes to string values, making results much easier to interpret. Using a bit of our magical text skills, we can get the relevant information out of this file (see Your Turn question #1).
***the annoying thing about this database is that the dbf variable names have nothing to do with DBF variable names***


***Give some idea of the complexity of the data files***

Figure \@ref(fig:map-2014) gives an overview of all geographical locations where an accident resulting in at least one fatality was recording in 2014. A pretty detailed roadmap of the US is the result.

```{r map-2014, fig.cap='Overview of where fatal accidents occurred in 2014', out.width='80%', fig.asp=.75, fig.align='center', message=FALSE, warning = FALSE}
library(ggplot2)
library(foreign)

accidents <- read.dbf("data/FARS2014-DBF/accident.dbf")
qplot(LONGITUD, LATITUDE, data=subset(accidents, dplyr::between(LONGITUD, -130, 0)), size=I(.5), alpha=I(0.5))
```

## When do people die on the roads? 

Figure \@ref(fig:when) gives an overview of when fatal accidents happen on the road: on weekdays, the number of deaths peaks twice a day during times when people commute. During the morning commute the number of deaths shows a small peak with a mode around 6am. A second, much bigger mode follows the afternoon commute with a peak at around 6pm. These peaks in the number of detahs is by far outdone by the number of deaths from fatal accidents on weekend nights and early mornings starting with Friday afternoon and lasting until Sunday around 10pm. 

```{r when, message=FALSE, warning = FALSE, fig.cap='Number of fatalities from car accidents by time of the day and hour of the week.', out.width='100%', fig.asp=.65, fig.align='center'}
library(dplyr)
drunk_by_day <- accidents %>% group_by(DAY_WEEK, HOUR) %>% 
  summarize(
    accidents = n(),
    deaths = sum(FATALS),
    drunk = sum(DRUNK_DR*FATALS > 0)
  )
drunk_by_day$drunkPerc <- with(drunk_by_day, drunk/deaths*100)
drunk_by_day$HOUR[drunk_by_day$HOUR == 99] <- NA
drunk_by_day$DAY_WEEK <- factor(drunk_by_day$DAY_WEEK)
levels(drunk_by_day$DAY_WEEK) <- c("Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday")
drunk_by_day$DAY_WEEK <- factor(drunk_by_day$DAY_WEEK, levels=c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"))

qplot(data=drunk_by_day, geom="bar", x=HOUR, weight=deaths, colour=I(NA)) + facet_wrap(~DAY_WEEK, ncol=4)
```


The variable ```DRUNK_DR``` is the number of drivers involved in the crash who tested as being above the legal limit of alcohol, i.e. were legally drunk. 
Days of the week are encoded as 1 for Sunday through 7 for Saturday, the dots in Figure \@ref(fig:drunk) show the percentage of accidents in which at least one of the drivers was drunk. On Saturdays and Sundays the percentage of drunk drivers is generally higher, but on all days of the week, fatal accidents that occur after 8 pm and before 5 am have an over 30% chance of involving a drunk driver. During the very early hours of the morning this rate spikes to well over 50% even on weekdays!

```{r drunk, message=FALSE, warning = FALSE, fig.cap='Percentage of accidents where at least one of the drivers was legally drunk by day of the week and time of the day. Late nights and early mornings have particularly high frequencies.', out.width='80%', fig.asp=.75, fig.align='center'}

qplot(HOUR, drunkPerc, data=drunk_by_day, colour=DAY_WEEK, geom="point", group=DAY_WEEK) + theme_bw() + geom_smooth(se=FALSE)
```

## What contributes to fatal accidents?

```CF``` is a variable encoding contributing factors. For more than 90% of all accidents no contributing factors are recorded, but for the remainder, the most frequent factors are (14) falling cargo followed by (20) police pursuit (see Figure \@ref(fig:what) ).

```{r, echo=FALSE}
getLevels <- function(varname, file) {
  formats <- readLines(con=file)
  found <- grep(varname, formats)
  if (length(found) == 0) {
    stop(sprintf("Error: no level information found for variable %s\n", varname))
  }
  # semicolons indicate end of lines
  semicolons <- grep(";", formats)
  
  #read lines from found to next semicolon
  endOfRead <- semicolons[which(semicolons - found > 0)[1]]
  dframe <- read.table(file, header=FALSE, sep= "=", skip = found, nrows=endOfRead-found-1)
  dframe
}

# getLevels("MFACTOR", "data/FARS2014-DBF/Format14.sas")
# getLevels("STATE", "data/FARS2014-DBF/Format14.sas")
```

```{r what, fig.cap='Number of accidents by contributing factor. Contributing factor 0 stands for "none".', out.width='80%', fig.asp=.75, fig.align='center', message=FALSE, warning = FALSE}
enc <- getLevels("ARF14F", "data/FARS2014-DBF/Format14.sas")
names(enc) <- c("CF1", "Label")

qplot(reorder(CF1, CF1, length), data=accidents, geom="bar") + coord_flip() + 
  geom_text(aes(label=Label), y=1000, data=enc, hjust=0)

```

Was the driver distracted? - The answer to this question is recorded in the variable ```MDRDSTRD``` and summarised in Figure @\ref(fig:MDRDSTRD).

```{r MDRDSTRD, fig.cap='Number of accidents by factors distracting the driver', out.width='80%', fig.asp=.75, fig.align='center', message=FALSE, warning = FALSE}
distract <- read.dbf("data/FARS2014-DBF/Distract.dbf")
enc2 <- getLevels("DRDIS14F", "data/FARS2014-DBF/Format14.sas")
names(enc2) <- c("MDRDSTRD", "Label")

qplot(reorder(MDRDSTRD, MDRDSTRD, length), data=distract, geom="bar", fill=MDRDSTRD %in% c("05","06","15")) + coord_flip() + 
  scale_fill_discrete("Cell phone related distraction") + 
  geom_text(aes(label=Label), y=1000, data=enc2, hjust=0)
```

0 stands for 'Not distracted'. 99 is code for 'unkown',
96 is a non-report, and 93 stands for a non-specific 'inattention'.

Was there somethings wrong with the vehicle? Figure \@ref(fig:MFACTOR) shows the most common contributing factors. Besides 0 'none' and 99 'unkown', the most factors are defects to the tires (1). 

```{r MFACTOR, fig.cap='Number of accidents by pre-existing conditions pertaining the vehicles involved', out.width='80%', fig.asp=.75, fig.align='center', message=FALSE, warning = FALSE}
factor <- read.dbf("data/FARS2014-DBF/Factor.dbf")
enc3 <- getLevels("FACTR14F", "data/FARS2014-DBF/Format14.sas")
names(enc3) <- c("MFACTOR", "Label")

qplot(reorder(MFACTOR, MFACTOR, length), data=factor, geom="bar") + coord_flip() +
  geom_text(aes(label=Label), y=1000, data=enc3, hjust=0)
```


## Who is driving drunk?

Assuming, individuals on the front left seat are drivers, we see in Figure \@ref(fig:drivers) that on weekdays there is not a big difference in the drunk driving pattern between male and female drivers, but starting Friday afternoon and early evening a gap opens up: a higher percentage of men involved in a fata accident are driving drunk than women in the evenings and early morning hours until during Monday mornings the gap closes again.
```{r drivers, fig.cap='Percentages of drunk drivers involved in a fatal accident by gender, time of the day and day of the week.', out.width='80%', fig.asp=.75, fig.align='center', message=FALSE, warning = FALSE}
person <- read.dbf("data/FARS2014-DBF/person.dbf")
driver <- subset(person, SEAT_POS == 11) # front left seat
driver$Date <- with(driver, as.Date(sprintf("2014/%s/%s", MONTH, DAY)))
driver$DAY_WEEK <- lubridate::wday(driver$Date, label=TRUE)
drunk <- driver %>% group_by(HOUR, SEX, DAY_WEEK) %>%
  summarize(
    n = n(),
    drunk = sum(DRINKING==1)
  )
drunk$HOUR[drunk$HOUR==99] <- NA
drunk$drunkPerc <- with(drunk, drunk/n*100)
drunk$SEX[drunk$SEX > 2] <- NA
drunk$SEX <- factor(drunk$SEX)
levels(drunk$SEX) <- c("Male", "Female")

qplot(HOUR, drunkPerc, data=na.omit(drunk), colour=factor(SEX),  geom="point", group=interaction(SEX, DAY_WEEK)) + theme_bw() + geom_smooth(se=FALSE) + facet_wrap(~DAY_WEEK)
```


## Your Turn

+ Use the structure you find in file [Format14.sas](data/FARS2014-DBF/Format14.sas) as the basis to write a function ```getLevels(varname, file)``` that takes a variable name and a sas file, and returns a dataframe with all levels of the variable in a numeric format and the level names as strings. 




